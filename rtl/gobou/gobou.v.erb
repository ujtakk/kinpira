% load "gobou.rb"

// Template to ignore unnecessary output ports.
// enumerate in quoted list of verilog-regexp-words.
/* AUTO_LISP (setq verilog-auto-output-ignore-regexp
    (verilog-regexp-words `(
      ""
   ))) */

module gobou(/*AUTOARG*/);
`include "gobou.vh"

  /*AUTOINPUT*/
  input                     clk;
  input                     xrst;
  input                     req;
  input                     img_we;
  input [IMGSIZE-1:0]       input_addr;
  input [IMGSIZE-1:0]       output_addr;
  input signed [DWIDTH-1:0] write_img;
  input [CORELOG:0]         net_we;
  input [NETSIZE-1:0]       net_addr;
  input signed [DWIDTH-1:0] write_net;
  input [LWIDTH-1:0]        total_out;
  input [LWIDTH-1:0]        total_in;
% if $dist
  input signed [DWIDTH-1:0] read_img;
% end

  /*AUTOOUTPUT*/
  output                      ack;
% if $dist
  output                      mem_img_we;
  output [IMGSIZE-1:0]        mem_img_addr;
  output signed [DWIDTH-1:0]  write_mem_img;
% else
  output signed [DWIDTH-1:0]  read_img;
% end

  /*AUTOWIRE*/

  /*AUTOREG*/

  gobou_ctrl ctrl(/*AUTOINST*/);

% if !$dist
  /* gobou_mem_img AUTO_TEMPLATE (
      .read_data  (read_img[DWIDTH-1:0]),
      .write_data (write_mem_img[DWIDTH-1:0]),
      .mem_we     (mem_img_we),
      .mem_addr   (mem_img_addr[IMGSIZE-1:0]),
  ); */
  gobou_mem_img mem_img(/*AUTOINST*/);
% end

  <%- for i in 0...$core -%>
  /* gobou_mem_net AUTO_TEMPLATE (
      .read_data  (read_net<%=i%>[DWIDTH-1:0]),
      .write_data (write_net[DWIDTH-1:0]),
      .mem_we     (mem_net_we[<%=i%>]),
      .mem_addr   (mem_net_addr[NETSIZE-1:0]),
  ); */
  gobou_mem_net mem_net<%=i%>(/*AUTOINST*/);

  /* gobou_core AUTO_TEMPLATE (
      .pixel (read_img[DWIDTH-1:0]),
      .weight (read_net<%=i%>[DWIDTH-1:0]),
      .result (result<%=i%>[DWIDTH-1:0]),
  ); */
  gobou_core core<%=i%>(/*AUTOINST*/);
  <%- end -%>

  /* gobou_serial_vec AUTO_TEMPLATE (
      <%- $core.times do |i| -%>
      .in_data<%=i%> (result<%=i%>[DWIDTH-1:0]),
      <%- end -%>
      .out_data (write_result[DWIDTH-1:0]),
  ); */
  gobou_serial_vec serial(/*AUTOINST*/);

endmodule

